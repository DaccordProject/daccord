name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  GODOT_VERSION: "4.6"
  GUT_VERSION: "9.5.0"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install gdtoolkit
        run: pip install gdtoolkit

      - name: Run gdlint
        run: gdlint scripts/ scenes/

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    environment: default
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Checkout accordkit
        uses: actions/checkout@v4
        with:
          repository: DaccordProject/accordkit
          token: ${{ secrets.GH_PAT }}
          path: .accordkit_repo

      - name: Checkout accordstream
        uses: actions/checkout@v4
        with:
          repository: DaccordProject/accordstream
          token: ${{ secrets.GH_PAT }}
          path: .accordstream_repo

      - name: Symlink addons
        run: |
          ln -sf $GITHUB_WORKSPACE/.accordkit_repo/addons/accordkit addons/accordkit
          ln -sf $GITHUB_WORKSPACE/.accordstream_repo/addons/accordstream addons/accordstream

      - name: Cache GUT
        uses: actions/cache@v4
        with:
          path: addons/gut
          key: gut-${{ env.GUT_VERSION }}

      - name: Install GUT
        run: |
          if [ ! -d addons/gut ]; then
            wget -q https://github.com/bitwes/Gut/releases/download/v${GUT_VERSION}/Gut.${GUT_VERSION}.zip -O /tmp/gut.zip
            unzip -o /tmp/gut.zip -d /tmp/gut_extract
            # The zip may contain addons/gut/ directly or a top-level folder
            if [ -d /tmp/gut_extract/addons/gut ]; then
              cp -r /tmp/gut_extract/addons/gut addons/gut
            else
              # Find the gut directory wherever it is
              GUT_DIR=$(find /tmp/gut_extract -type d -name "gut" | head -1)
              cp -r "$GUT_DIR" addons/gut
            fi
            rm -rf /tmp/gut.zip /tmp/gut_extract
          fi

      - name: Set up Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: false

      - name: Verify Godot
        run: godot --version

      - name: Import project
        run: godot --headless --import . || true
        timeout-minutes: 2

      - name: Run unit tests
        run: |
          godot --headless -s addons/gut/gut_cmdln.gd \
            -ginclude_subdirs=true \
            -gprefix=test_ \
            -gsuffix=.gd \
            -glog=1 \
            -gdir=res://tests/unit
        timeout-minutes: 5

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    environment: default
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Checkout accordkit
        uses: actions/checkout@v4
        with:
          repository: DaccordProject/accordkit
          token: ${{ secrets.GH_PAT }}
          path: .accordkit_repo

      - name: Checkout accordstream
        uses: actions/checkout@v4
        with:
          repository: DaccordProject/accordstream
          token: ${{ secrets.GH_PAT }}
          path: .accordstream_repo

      - name: Checkout accordserver
        uses: actions/checkout@v4
        with:
          repository: DaccordProject/accordserver
          token: ${{ secrets.GH_PAT }}
          path: .accordserver_repo

      - name: Symlink addons
        run: |
          ln -sf $GITHUB_WORKSPACE/.accordkit_repo/addons/accordkit addons/accordkit
          ln -sf $GITHUB_WORKSPACE/.accordstream_repo/addons/accordstream addons/accordstream

      - name: Cache GUT
        uses: actions/cache@v4
        with:
          path: addons/gut
          key: gut-${{ env.GUT_VERSION }}

      - name: Install GUT
        run: |
          if [ ! -d addons/gut ]; then
            wget -q https://github.com/bitwes/Gut/releases/download/v${GUT_VERSION}/Gut.${GUT_VERSION}.zip -O /tmp/gut.zip
            unzip -o /tmp/gut.zip -d /tmp/gut_extract
            if [ -d /tmp/gut_extract/addons/gut ]; then
              cp -r /tmp/gut_extract/addons/gut addons/gut
            else
              GUT_DIR=$(find /tmp/gut_extract -type d -name "gut" | head -1)
              cp -r "$GUT_DIR" addons/gut
            fi
            rm -rf /tmp/gut.zip /tmp/gut_extract
          fi

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            .accordserver_repo/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('.accordserver_repo/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build accordserver
        run: cargo build --release --manifest-path .accordserver_repo/Cargo.toml

      - name: Start accordserver
        run: |
          ACCORD_TEST_MODE=true \
          DATABASE_URL="sqlite:accord_ci_test.db?mode=rwc" \
          .accordserver_repo/target/release/accordserver > test_server.log 2>&1 &
          echo "SERVER_PID=$!" >> $GITHUB_ENV

      - name: Wait for server readiness
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:39099/health > /dev/null 2>&1; then
              echo "Server is ready"
              exit 0
            fi
            sleep 1
          done
          echo "::error::Server failed to start within 30 seconds"
          cat test_server.log
          exit 1
        timeout-minutes: 1

      - name: Set up Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: false

      - name: Import project
        run: godot --headless --import . || true
        timeout-minutes: 2

      - name: Run integration tests
        run: |
          godot --headless -s addons/gut/gut_cmdln.gd \
            -ginclude_subdirs=true \
            -gprefix=test_ \
            -gsuffix=.gd \
            -glog=1 \
            -gdir=res://tests/accordkit
        timeout-minutes: 10

      - name: Stop accordserver
        if: always()
        run: |
          if [ -n "$SERVER_PID" ]; then
            kill "$SERVER_PID" 2>/dev/null || true
          fi

      - name: Upload server log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: accordserver-log
          path: test_server.log
